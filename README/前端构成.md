# 吊弦位置标记小车服务端

------

## 1. 项目概述

### 1.1 项目名称

**吊弦位置标记小车服务端**

### 1.2 项目目的

- 通过 **MQTT 协议** 与搭载 LET 模块（4G 模块）的 **吊弦定位小车** 通信。
- 服务端 **不直接控制小车运动轨迹**，而是：
  - 从手机客户端接收：任务参数配置、任务开始 / 暂停 / 继续 / 结束等操作；
  - 将这些操作转换为 MQTT 指令，下发给小车；
  - 同时订阅小车上报的各类数据，并进行 **计算、展示与记录**。
- 小车自身单片机内部有自动运行逻辑（测量钢柱、计算吊弦位置、执行往返行驶与标记动作）；
   本项目的职责仅限于：
  - 对不同 MQTT 主题进行 **数据下发**；
  - 对不同 MQTT 主题进行 **数据接收**；
  - 做 **后端运算** 和 **前端可视化展示**。

------

## 2. 项目背景与数据分类（物理含义）

> 本节基于《项目背景和数据分类》文档，说明吊弦定位任务中参数与测量数据的业务意义。

### 2.1 任务参数（由用户预先配置）

通过 MQTT 下发的参数包括：

- `side`（单位：cm）
  - 含义：从每根钢柱中心向跨距内部延伸的距离。
  - 示例：`side = 500` 表示 **5.00 m**。
- `num`（或报文字段 `num`，含义相同）：
  - 含义：整个跨距内吊弦的**总数量**，系统在两端吊弦之间（含端点）**均匀分布**。
  - 要求：`num ≥ 2`。

配合跨距长度使用时，有以下约束：

- 若某一跨的实际跨距长度 `span`（单位：m）满足 `span ≤ 2 × D`（其中 `D = side / 100.0`），则 **无有效吊弦区间**，应视为参数错误。

### 2.2 小车测量数据（由小车获得）

小车在轨道上通过 **激光 + 编码器** 等传感器实时测量：

- 第 N 根钢柱中心里程（P₁、P₂ 等）
  - 通过检测钢柱的 **进入边缘** 和 **离开边缘** 两个突变点，取中点作为该钢柱的中心。
  - 必须**完整驶过钢柱**，才能捕获两个边缘并计算中心。
- 跨距长度
  - 定义：`span = P₂ − P₁`（N 与 N+1 两根钢柱中心之间的距离）。
- 当前行驶里程
  - 由编码器积分得到，便于实时定位。
- 小车速度
  - 由编码器微分得到，用于自动控制。

### 2.3 单跨吊弦位置定义

设：

- P₁：小里程端钢柱中心里程；
- P₂：大里程端钢柱中心里程；
- D = `side / 100.0`（单位：m）；
- Nₘₐₓ = `num`（吊弦总数，≥2）。

则：

- **最小里程吊弦 d₁**：`d₁ = P₁ + D`
- **最大里程吊弦 dₘₐₓ**：`dₘₐₓ = P₂ − D`

必然满足：`P₁ < d₁ < dₘₐₓ < P₂`

吊弦按里程从小到大编号为：`d₁, d₂, …, dₘₐₓ`。

在 UI 形象坐标中，我们通常将当前跨距左端钢柱中心视为 **0 m**、右端钢柱中心视为 `span`，所有吊弦位置映射到 [0, span] 区间内。

### 2.4 吊弦等间距计算（用于前端显示）

对于前端展示用的 **单跨形象坐标图**，只需要知道：

- 当前跨跨度：`span`（m）—— 小车通过测量获得，通过 `task` 主题上报；
- 参数：
  - `side`（cm）；
  - `num`（总吊弦数）。

定义：

```text
D    = side / 100.0          # cm → m
span = 当前跨距长度（单位 m）
n    = num                   # 吊弦总数 ≥ 2
```

1. 有效吊弦区间长度：
    `L = span − 2 × D`
    若 `L ≤ 0`，则参数错误。
2. 吊弦间距（“中间吊弦距离”）：
    `Δ = L / (n − 1)`
   - 该值即 **跨内相邻两根吊弦之间的距离**。
3. 每根吊弦在本跨坐标系（以小里程钢柱中心为 0）的坐标：

```text
x₁ = D
x₂ = D + Δ
...
xᵢ = D + (i − 1) × Δ
...
xₙ = D + (n − 1) × Δ = span − D
```

示例（与需求文档示例一致）：

- `span = 45.67 m`
- `side = 500 cm → D = 5.00 m`
- `num = 6`
- `L = 45.67 − 10 = 35.67`
- `Δ = 35.67 / (6 − 1) = 7.134 m ≈ 7.13 m`

则形象坐标刻度为（从左到右）：

```text
0（小里程钢柱中心）
5.00（d₁）
12.13（d₂）
19.27（d₃）
26.40（d₄）
33.54（d₅）
40.67（d₆）
45.67（大里程钢柱中心）
```

------

## 3. MQTT 通信设计

### 3.1 MQTT 服务器配置

- 服务器地址：`124.222.86.236`
- 端口：`1883`
- 用户名：`railcar`（禁止匿名登录）
- 密码：`olivia167349@`

服务端需作为 MQTT 客户端连接上述 Broker，并根据业务需要**订阅**和**发布**对应主题。

### 3.2 主题与报文格式约定（逻辑）

| 主题名   | 方向          | 内容 / 格式示例                      | 说明                                                         |
| -------- | ------------- | ------------------------------------ | ------------------------------------------------------------ |
| `status` | 小车 → 服务端 | `{online}` / `{offline}`             | 小车在线状态心跳。                                           |
| `data`   | 服务端 → 小车 | `{side:500;num:6}`                   | 任务参数：两端吊弦位置 `side`（cm）和跨内总吊弦数 `num`。    |
| `cmd`    | 服务端 → 小车 | `{start}` `{stop}` `{con}` `{over}`  | 任务控制命令：开始、暂停、继续、结束。                       |
| `task`   | 小车 → 服务端 | `{ID:0001;span:45.67}`               | 单跨任务数据：跨序号 ID 与跨距长度 span（m）。               |
| `car`    | 小车 → 服务端 | `{spe:16.3;dis:00012636;dn:13;sn:2}` | 小车运行状态：车速、当前位置里程、已标记吊弦数、已标记跨数。 |

> 注：
>
> - `num` 字段在报文中使用，其业务含义与背景文档中的 `num` 一致，即“跨内总吊弦数”。
> - `status` 状态将直接驱动页面中的“小车状态：在线/离线”以及是否允许发送控制命令。

------

## 4. 前端整体结构与主页面

### 4.1 主页面结构

- 页面标题：**吊弦位置标记小车**（居中）
- 标题下方（整体居中）显示：**小车状态：在线 / 离线**
  - 根据 `status` 主题报文内容：
    - 收到 `{online}` → 显示 **在线**；
    - 收到 `{offline}` → 显示 **离线**。
- 标题/状态下方布局：
  - 四个子界面入口按钮，按 **2×2** 排列；
  - 四个按钮对应：
    1. 参数设置
    2. 小车控制
    3. 任务数据
    4. 工作日志
- 四个按钮区域下方，再展示小车简单状态信息（车速、位置、开机时间等，详见第 7 节）。

### 4.2 子界面弹窗样式共性

- 点击任一子界面按钮，弹出 **比主界面略小** 的弹窗；
- 弹窗大小：刚好包住子界面全部内容，不留大面积空白；
- 弹窗顶部居中显示各自子界面标题。

------

## 5. 子界面一：参数设置

### 5.1 UI 结构

- 弹窗标题：**参数设置**（居中）
- 内容自上而下排列：
  1. **两端吊弦位置（cm）：** 输入框
     - 对应参数 `side`，单位为 cm。
  2. **跨内总吊弦数：** 输入框
     - 对应参数 `num`（业务含义为跨内吊弦总数 `num`）。
  3. **数据锁定按钮**：
     - 初始文本：**锁定并发送**
     - 被点击后行为：
       - 将 1、2 两个输入框设为 **锁定** 状态：
         - 文本不可编辑；
         - 颜色变灰；
       - 按钮文本变为：**解锁**。

### 5.2 参数下发逻辑（锁定）

当用户在输入框中填写完成后：

- 点击 **“锁定并发送”** 时：

  - 将当前输入内容打包，通过 `data` 主题发送给小车；
     例如：

    ```text
    side = 500
    num  = 6
    ```

    则发送：

    ```text
    {side:500;num:6}
    ```

  - 若发送成功，进入“锁定”状态：

    - 输入框变灰并不可编辑；
    - 按钮文本变为 **“解锁”**。

> 此时，所有按 `side` / `num` 计算的后端逻辑（如吊弦坐标、形象图）将使用这一组锁定参数。

### 5.3 解锁条件与行为

- **解锁前置条件**：
   仅当“小车控制”子界面 **处于结束后的空闲状态**（即当前控制按钮显示为“开始”）时，才允许执行解锁操作。
- 当满足条件，用户点击“解锁”按钮时：
  - 1、2 输入框恢复为可编辑状态；
  - 输入框颜色恢复；
  - 按钮文本回到 **“锁定并发送”**；
  - 后续需要重新点击“锁定并发送”后才会再次下发新参数。

------

## 6. 子界面二：小车控制

### 6.1 UI 结构

- 弹窗标题：**小车控制**（居中）
- 主要由任务控制按钮组成，包含以下状态转换：

### 6.2 控制状态机与 MQTT 指令

1. **初始 / 空闲状态**
   - 显示按钮：【开始】
   - 点击【开始】：
     - 前提检查：
       - 若参数设置未“锁定并发送”：
         - 弹出 Toast：**“参数未锁定”**
         - 不发送任何 MQTT 指令；
       - 若小车当前为离线（`status = offline`）：
         - 弹出 Toast：**“小车未在线”**
         - 不发送任何 MQTT 指令。
     - 若通过前提检查：
       - 向 `cmd` 主题发送：`{start}`
       - 前端状态进入 **“运行”状态**：
         - 控制按钮更新为：【暂停】
2. **运行状态**
   - 当前按钮：【暂停】
   - 点击【暂停】：
     - 向 `cmd` 主题发送：`{stop}`
     - 状态切换为 **“暂停”状态**；
     - 控制按钮区域显示为：【继续】【结束】 两个按钮。
3. **暂停状态**
   - 显示按钮：【继续】【结束】
   - 点击【继续】：
     - 向 `cmd` 主题发送：`{con}`
     - 状态切回 **“运行”状态**；
     - 控制按钮恢复为：【暂停】。
   - 点击【结束】：
     - 向 `cmd` 主题发送：`{over}`
     - 状态回到 **“初始 / 空闲状态”**：
       - 控制按钮变回：【开始】；
       - 此状态也满足“参数可以解锁”的条件（见 5.3）。

------

## 7. 子界面三：任务数据

### 7.1 UI 结构

- 弹窗标题：**任务数据**（居中）
- 下方内容根据当前任务进度动态变化。

### 7.2 情况一：任务未开始

- 当当前任务尚未有任何跨距测量数据（未收到 `task` 主题数据）时：
  - 页面只显示一行文字：
    - **“任务未开始”**

### 7.3 情况二：任务进行中（收到跨距数据后）

当小车完成某一跨（从 P₁ 到 P₂）的测量后，会向 `task` 主题发送：

```text
{ID:0001;span:45.67}
```

含义：

- `ID`：跨序号（如 0001 表示第 1 跨）；
- `span`：该跨 **跨距长度（单位：m）**，如 45.67 m。

前端在接收到一条 `task` 数据后，应在“任务数据”界面中：

1. 根据当前任务参数（`side`、`num`）与 `span`，计算该跨的：
   - 吊弦间距（中间吊弦距离 Δ）；
   - 每根吊弦在本跨形象坐标中的位置（见 2.4）。
2. 在标题下方生成一块该跨的展示区域，格式示例：

```text
跨1：跨距：45.67m  中间吊弦距离：7.13m
[跨1的形象坐标图]
```

其中：

- “跨1”：来自 `ID:0001`；
- “跨距：45.67m”：来自 `span:45.67`；
- “中间吊弦距离：7.13m”：使用上述公式计算的 Δ；
- “跨1的形象坐标图”：
  - 以一条线段表示整跨：
    - 左端刻度：0（代表小里程钢柱中心）；
    - 右端刻度：45.67（代表大里程钢柱中心）；
  - 中间根据计算得到的吊弦位置，绘制刻度并标注文字：
    - 刻度顺序为：小里程钢柱中心 → d₁ → d₂ → … → dₙ → 大里程钢柱中心；
    - 文本上采用 **上下交错的方式标数字**，避免数字互相遮挡；
    - 示例刻度文本（与需求一致）：
       `0  5.00  12.13  19.27  26.40  33.54  40.67  45.67`。

### 7.4 多跨任务的展示与等待状态

当第 1 跨测量完成并展示后，应开始为下一跨预留显示区域：

- 在 **跨 1** 渲染完成后，即生成 **跨 2** 的占位信息：

  ```text
  跨2：跨距：测量中···  中间吊弦位置：测量中···
  等待测量后显示形象图
  ```

- 等小车完成第 2 跨测量并通过 `task` 主题发送对应数据后：

  - 用实际数据覆盖“测量中···”；
  - 同时按照 7.3 的逻辑绘制“跨 2 的形象坐标图”；
  - 然后再为 **跨 3** 自动生成类似的“测量中···”占位信息。

- 如此循环，保证“当前跨完整展示后才生成下一跨的等待信息”。

### 7.5 历史任务数据

在任务数据界面的最底部，展示 **“历史任务数据”** 区域，用于记录：

- 历史任务中 **每一跨** 的：
  - 跨号（ID）
  - 跨距（span）
  - 参数 `side`、`num`
  - 吊弦位置、形象坐标图等
- 该区域应包含“历史任务的所有信息”，便于后续查询与分析。

> 具体展示形式（列表、折叠面板、分页等）可根据项目需求自行设计，但信息内容要完整。

------

## 8. 子界面四：工作日志

### 8.1 UI 结构

- 弹窗标题：**日志**（或“工作日志”），居中显示。

### 8.2 日志内容范围

可记录但不限于：

- MQTT 通信日志：
  - 订阅与连接状态；
  - 各主题消息的发送与接收（可做精简）。
- 工作状态日志：
  - 小车上线 / 下线时间；
  - 任务开始 / 暂停 / 继续 / 结束时间及操作者；
  - 参数变更（side、num）的记录；
  - 每一跨任务的测量与展示过程中的关键事件。

> 日志内容允许“自行增加各种日志”，但需包含 **MQTT 通信** 与 **工作状态** 等核心信息。

------

## 9. 主页面下方：小车简单状态介绍

### 9.1 显示字段

在四个子界面按钮区域下方，实时展示以下信息：

- 车速：`xx.x km/h`
- 位置：`DKXXX+XXX.XX`
  - 表示当前里程为 `XXX km XXX m XX cm`；
- 开机时间：`xxhxxm`
  - 表示小车从 **离线** 变为 **在线** 后累计运行时长；
- 已标记吊弦数量：`xx`
- 已标记跨距数量：`xx`

### 9.2 数据来源与解析

小车会周期性向 `car` 主题发送状态数据，例如：

```text
{spe:16.3;dis:00012636;dn:13;sn:2}
```

服务端与前端的处理方式：

- `spe`：车速
  - 示例：`spe:16.3` → 显示为 **“车速：16.3 km/h”**。
- `dis`：当前里程（字符串形式的数字，例如 8 位）
  - 示例：`dis:00012636`：
    - 解析为：`DK000+126.36`；
    - 对应含义：**000 km 126 m 36 cm**。
- `dn`：已标记吊弦数量
  - 示例：`dn:13` → 显示为 **“已标记吊弦数量：13”**。
- `sn`：已标记跨距数量
  - 示例：`sn:2` → 显示为 **“已标记跨距数量：2”**。

### 9.3 开机时间计算

- 当 `status` 由 `{offline}` 变为 `{online}` 的时刻，记录为本次“开机时间起点”；
- 前端或后端每秒刷新一次：
  - 当前时间 − 开机起点时间 = 运行时长；
  - 显示为 `xx时xx分xx秒` 三段式格式。

------

## 10. 逻辑关系总览（写作逻辑梳理）

### 附：MQTT 连接弹窗

- 入口：在“工作日志”弹窗顶部点击“MQTT 连接”按钮，弹出独立的配置弹窗（带右上角关闭按钮）。
- 目的：用于切换 MQTT 服务器地址、端口、用户名、密码以及订阅主题，便于在现场网络变化时快速重连。
- 行为：点击“保存并重连”后，后端立即使用新配置重建连接，工作日志会记录切换动作。

1. **参数配置阶段**
   - 用户在“参数设置”界面填写 `side`、`num`；
   - 点击“锁定并发送”→ 下发到 `data` 主题；参数锁定；
   - 只有当小车控制处于“结束后空闲状态（按钮为‘开始’）”时，才允许解锁并修改参数。
2. **任务控制阶段**
   - 在“小车控制”界面，根据当前状态点击：
     - 开始 → `{start}`（需参数已锁定且小车在线）；
     - 暂停 → `{stop}`；
     - 继续 → `{con}`；
     - 结束 → `{over}`（回到空闲状态）。
   - 同时，“参数设置”是否可解锁取决于这里是否回到了空闲。
3. **数据采集与计算阶段**
   - 小车在轨道上自动完成钢柱边缘检测、中心计算、跨距测量与吊弦标记逻辑；
   - 完成每一跨（从 P₁ 到 P₂）的测量后，通过 `task` 发送 `{ID; span}`；
   - 服务端利用当前锁定的 `side`、`num` 与 `span`，计算吊弦位置和中间吊弦距离 Δ。
4. **任务数据展示阶段**
   - “任务数据”界面：
     - 若无任何 `task` 数据 → 显示“任务未开始”；
     - 若已有跨数据：
       - 按跨序逐一展示：跨距 + 中间吊弦距离 + 形象坐标图；
       - 当某一跨展示完成后，为下一跨生成“测量中···”占位文本；
       - 同时在底部维护“历史任务数据”。
5. **小车状态监控与日志**
   - 主页面通过 `status` 和 `car` 不断刷新：
     - 在线 / 离线；
     - 车速、位置、开机时间、已标记吊弦/跨数；
   - “工作日志”记录所有关键事件与 MQTT 消息摘要。

------

以上即为在 **不改变原始业务含义** 的前提下，对“项目背景和数据分类”以及功能需求进行的整体写作逻辑整理与 Markdown 结构化说明。