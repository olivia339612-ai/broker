# 铁路吊弦定位小车：参数与测量数据分类说明

本项目中，吊弦位置的计算依赖两类信息：
- 用户预先配置的作业参数（通过 4G 模块 MQTT 协议下发）
- 小车在轨道上实时测量的数据（通过传感器 + 编码器获取）

## 一、需提前输入的参数（由用户配置）

| 参数名             | 单位   | 说明 |
|--------------------|--------|------|
| `side`    | 厘米（cm） | 从每根钢柱中心向跨距内部延伸的距离。<br>例如：`523` 表示 5.23 米。 |
| `num` | 无（整数 ≥ 2） | 整个跨距内吊弦的总数量，系统在两个端部吊弦之间（含端点）均匀分布。 |

约束条件：
- `num ≥ 2`
- 若实测跨距长度 ≤ 2 × D，则报错。

## 二、小车需实时测量的数据

| 数据项                | 获取方式 | 说明 |
|----------------------|----------|------|
| 第 N 根钢柱中心里程 | 激光 + 编码器 | 通过检测钢柱**两个边缘**（进入和离开时的突变），取中点作为中心里程。**必须完整驶过钢柱**才能获得两个边缘。 |
| 跨距长度            | 计算得出 | = 第 N+1 根钢柱中心里程 − 第 N 根钢柱中心里程 |
| 当前行驶里程        | 编码器积分 | 用于实时定位 |
| 小车速度            | 编码器微分 | 用于平滑控制 |

> **关键前提**：为准确计算钢柱中心，小车**必须完整驶过该钢柱**，以捕获其前后两个边缘信号。

## 三、吊弦位置定义（单跨距）

设：
- **P₁** = 第 N 根钢柱中心里程（小里程端）
- **P₂** = 第 N+1 根钢柱中心里程（大里程端）
- **D** = `side / 100.0`（单位：米）
- **N<sub>max</sub>** = `num`（总吊弦数，≥2）

则：
- **最小里程吊弦（d₁）** = P₁ + D
- **最大里程吊弦（d<sub>max</sub>）** = P₂ − D

必然满足：
**P₁ < d₁ < d<sub>max</sub> < P₂**

吊弦按里程从小到大编号为：
**d₁, d₂, ..., d<sub>max</sub>**

## 四、单跨距作业流程（必须驶过 P₂）

1. 小车从跨距前方（< P₁）出发，**正向行驶**（里程递增）。
2. **驶过 P₁**：
   - 激光检测到第一根钢柱小里程边缘 → 记录位置 E<sub>1min</sub> 
   - 继续行驶，检测到第一根钢柱大里程边缘 → 记录位置 E<sub>1max</sub> 
   - 计算第一根钢柱的中心里程 P₁ = (E<sub>1max</sub>  + E<sub>1min</sub>) / 2
3. 继续正向行驶，**驶过 P₂**：
   - 同样捕获前后边缘，计算第二根钢柱的中心里程 P₂ =(E<sub>2max</sub>  + E<sub>2min</sub>) / 2
   - **至此，跨距 [P₁, P₂] 确认完成**
4. 检测到第二根钢柱后缘后，**立即开始减速**，最终停在 **P₂ + 几十厘米** 处（大里程端安全余量）。
5. **倒车返回**，精确停靠至 **d<sub>max</sub>（= P₂ − D）**。
   
   > 注意：d<sub>max</sub> < P₂，因此小车需在驶过 P₂ 后**倒车一小段**，回到 d<sub>max</sub>。
6. **从 d<sub>max</sub> 开始，继续倒车**（里程递减），依次停靠：
   
   - **d<sub>max</sub> → d<sub>max−1</sub> → … → d₂ → d₁**
   - 每到一点，触发标记（蜂鸣器/喷码）。
7. 到达 d₁ 后，完成该跨距标记。
8. **反转电机，恢复正向行驶**，驶向下一根钢柱。

## 五、示例（单跨距）

钢柱真实位置（边缘）：
- 钢柱1：前缘 99.0 m，后缘 101.0 m → P₁ = 100.0 m
- 钢柱2：前缘 149.0 m，后缘 151.0 m → P₂ = 150.0 m

用户参数：
- `side = 500` → D = 5.0 m
- `num = 6`

计算：
- d₁ = 100.0 + 5.0 = 105.0 m
- d₆ = 150.0 − 5.0 = 145.0 m

**作业路径**：
1. 正向行驶：
   - 99.0 m：检测钢柱1前缘
   - 101.0 m：检测钢柱1后缘 → 算出 P₁ = 100.0 m
   - 149.0 m：检测钢柱2前缘
   - 151.0 m：检测钢柱2后缘 → 算出 P₂ = 150.0 m（**必须驶过 151.0 m**）
   - **驶过第二根钢柱后缘后开始减速**，最终停车在 ≈150.3 m（大里程端安全余量）
2. **倒车返回至 d₆ = 145.0 m**，停车。
3. 倒车标记：145.0 → 137.0 → 129.0 → 121.0 → 113.0 → 105.0
4. 在 105.0 m 完成后，**转为正向**，驶向下一钢柱。

## 六、多跨距衔接

- 完成当前跨距后，小车从 d₁（≈P₁ + D）处**正向驶出**。
- 在后续行驶中，**再次驶过 P₂**（作为下一跨距的起点钢柱），捕获其两个边缘，重新计算其中心（用于下一跨距的 P₁' = P₂）。
- 继续前行识别 P₃，重复流程。

> 驶向“下一根钢柱”的含义：  
> 当前跨距的两根钢柱编号为 N（P₁）与 N+1（P₂）。  
> 当小车完成 N 到 N+1 跨距的标记后**即此时处于该跨距最小里程的吊弦位置处**，**继续正向行驶，再次驶过的下一根钢柱即为 N+1（原 P₂）**，此时将其作为**新跨距的起点钢柱（P₁' = P₂）**，并继续向前识别 N+2 根钢柱，形成新的跨距 [P₁', P₂']。

此逻辑确保：
- 每根钢柱都被完整驶过，中心里程准确；
- 吊弦严格位于两钢柱中心之间；
- 作业路径可执行、无逻辑矛盾。
